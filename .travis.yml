language: android
jdk: oraclejdk7
env:
  matrix:
    - ANDROID_TARGET=android-23  ANDROID_ABI=armeabi-v7a
  global:
    - COVERALLS_REPO_TOKEN=gMnsR0XfIpFzW5H13OJGqbxns9L1rBnB1
sudo: false

# Android config
android:
  components:
    - platform-tools
    - build-tools-21.1.2
    - android-23
    - extra-android-support
    - extra-android-m2repository
  licenses:
    - '.+'

# Send notifications on Android Slack channel.
notifications:
  email: false
  slack:
    rooms:
      secure: "AdW02OHYc6Vjuf1PCc+pJVTStqxFU8hJCsdOfCIy8lqod3df/BQpVvy1biKyjFhFa7GySWvkuGdTW9eAF8j7q/OvXF4I7Gqejqi2nXszXqOQQc7gSLFsmwLxBTiPOrqc2WNeV2OPIzOxZpTZVI8D7TlP/7NdzA3QFTXyJlOnhC6jMflqliMqxMNRWEwFRj3HIPFdLpE8ABysnWsN4JV2TZvRVcQHlnI05y56vivZuGS1qUidIaoCAaX0okdN/jDdifVREFxXdjYk1Iy3oAZLgOednSwvRrUohQabJ9w98PIOKmko1khBGSe6iRYYmCtTariZM1uMqNL9mUv0RZ2dYBkY+NcAMcZ0dS4yODKjcqyGOIoXGIR97EogfJ/83ossgqS30r15bb8UcoNQwVmBuNk09MBWwblCJ8ICvOPZmharwdMFt6a9FDYPFDOz7rgA+cdIGSlGLsYgtf5tdh0/w3CGF0idP1C/Z6Lgl3jP2nK0rPXxN5FLxNHDcjetS82of/YlNR2yEj+FDMciyBj0U27wTcJnGtsWnv7zoriMwtWjUnpJMDNWHJ5VIF57dLawkQb4lKEDcWktzO7HdtbNAYSk6BEkZp7bMaDYx4WNpnfegLw4OM2NZztyZv77KGtsSg0+N+MFh53gEuwxdx68UPIrV2nU5RRspWgwSxG5zZM="

# Set up.
before_install:
  # Dependencies
  - git clone git@github.com:itabulous/ledgecommon_android.git ~/build/itabulous/ledgecommon_android/
  - git clone git@github.com:itabulous/ledgelinkapi_android.git ~/build/itabulous/ledgelinkapi_android/
  # Create gradle.properties files.
  - echo "HOME=$HOME" > ~/build/itabulous/ledgecommon_android/gradle.properties
  - echo "HOME=$HOME" > ~/build/itabulous/ledgelinkapi_android/gradle.properties
  - echo "HOME=$HOME" > ~/build/itabulous/ledgelinksdk_android/gradle.properties

install:
  # Add dependencies to local m2 repo.
  - cd ~/build/itabulous/ledgecommon_android
  - gradle install
  - cd ~/build/itabulous/ledgelinkapi_android
  - gradle --configure-on-demand -p api install
  - gradle -p wrappers/wrapper-retrofit2 install
  - cd ~/build/itabulous/ledgelinksdk_android
  - gradle --configure-on-demand -p sdk install

# Running tests.
script:
  - gradle --configure-on-demand -p sdk testDebugUnitTest
  - gradle --configure-on-demand -p ui assembleDebug testDebugUnitTestCoverage

after_success:
  # Copy file to expected location.
  - mkdir -p ~/build/itabulous/ledgelinksdk_android/ui/build/reports/jacoco/test
  - cp ~/build/itabulous/ledgelinksdk_android/ui/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml ~/build/itabulous/ledgelinksdk_android/ui/build/reports/jacoco/test/jacocoTestReport.xml
  # Send coverage info to Coveralls.io.
  - gradle --configure-on-demand -p ui coveralls
